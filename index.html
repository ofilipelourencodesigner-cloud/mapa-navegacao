<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares — Base Estável</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#f6f7fb}
    #top{position:fixed;z-index:10;left:0;right:0;top:0;background:#fff;border-bottom:1px solid #e8eef9;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #title{font-weight:800;font-size:20px;margin-right:6px}
    select,button{padding:10px 12px;border:1px solid #d6e1f4;border-radius:10px;font-size:15px;background:#fff}
    .primary{background:#0b74de;color:#fff;border:none;font-weight:700}
    .ghost{background:#fff}
    #map{position:fixed;left:0;right:0;top:72px;bottom:12px}
    .marker-num{background:#fff;border:2px solid #0b74de;border-radius:10px;padding:6px 8px;font-weight:800;font-size:12px}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <div id="top">
    <div id="title">Rotas Escolares — Base</div>

    <label for="rotaSelect" style="font-size:14px">Escolha a rota:</label>
    <select id="rotaSelect" style="min-width:240px">
      <option value="">-- selecione --</option>
    </select>

    <button id="btnAvancar" class="primary">Avançar</button>
    <button id="btnMostrar" class="ghost">Mostrar visão geral</button>

    <div id="status" class="muted" style="margin-left:auto">Status: pronto</div>
  </div>

  <div id="map"></div>

  <script>
    // ========== CONFIG ==========
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ';
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // ========== ESTADO ==========
    let MAP=null, markers=[];
    let ROTAS=[], rotaAtual=null, pontos=[], routeFull=null;

    // ========== MAPA ==========
    function initMap(){
      MAP = new mapboxgl.Map({
        container:'map',
        style:'mapbox://styles/mapbox/navigation-day-v1',
        center:[-48.40401957175889,-22.960993547862227],
        zoom:12
      });
      MAP.addControl(new mapboxgl.NavigationControl());
      MAP.on('load', ()=>{
        // fontes e camadas
        MAP.addSource('route-source',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
        MAP.addLayer({
          id:'route-line-halo', type:'line', source:'route-source',
          filter:['==',['get','kind'],'route'],
          paint:{'line-color':'#9ec5ff','line-width':14,'line-opacity':0.9,'line-cap':'round','line-join':'round'}
        });
        MAP.addLayer({
          id:'route-line', type:'line', source:'route-source',
          filter:['==',['get','kind'],'route'],
          paint:{'line-color':'#3b82f6','line-width':8,'line-opacity':0.98,'line-cap':'round','line-join':'round'}
        });
      });
    }
    initMap();

    function setStatus(t){ document.getElementById('status').textContent = t; }

    // ========== CARREGAR ROTAS ==========
    async function loadRotas(){
      try{
        const r=await fetch('rotas.json',{cache:'no-store'});
        ROTAS = await r.json();
        const sel=document.getElementById('rotaSelect');
        sel.innerHTML = '<option value="">-- selecione --</option>';
        ROTAS.forEach(rt=>{
          const o=document.createElement('option');
          o.value=rt.id;
          o.textContent = `Rota ${rt.id} - ${rt.nome}`;
          sel.appendChild(o);
        });
        setStatus('Rotas carregadas.');
      }catch(e){
        console.error(e);
        setStatus('Erro ao carregar rotas.json');
      }
    }
    loadRotas();

    // ========== UI ==========
    document.getElementById('btnAvancar').addEventListener('click', ()=>{
      const id = parseInt(document.getElementById('rotaSelect').value,10);
      rotaAtual = ROTAS.find(r=>r.id===id) || null;
      if(!rotaAtual){ alert('Selecione uma rota.'); return; }

      // limpar marcadores & linha
      markers.forEach(m=>m.remove()); markers=[];
      if (MAP.getSource('route-source')){
        MAP.getSource('route-source').setData({type:'FeatureCollection',features:[]});
      }
      // pontos
      pontos = rotaAtual.pontos.map(p=>({nome:p.nome, lat:+p.latitude, lon:+p.longitude}));
      // marcadores
      pontos.forEach((p,i)=>{
        const el=document.createElement('div'); el.className='marker-num'; el.textContent=(i+1);
        const mk=new mapboxgl.Marker({element:el}).setLngLat([p.lon,p.lat]).addTo(MAP);
        markers.push(mk);
      });
      // enquadrar
      const xs=pontos.map(p=>p.lon), ys=pontos.map(p=>p.lat);
      MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});
      setStatus(`Rota ${rotaAtual.id} pronta — ${pontos.length} pontos.`);
    });

    document.getElementById('btnMostrar').addEventListener('click', async ()=>{
      if(!pontos.length){ alert('Selecione a rota e clique em Avançar.'); return; }
      try{
        const coords=pontos.map(p=>[p.lon,p.lat]);
        const qs = new URLSearchParams({
          access_token: MAPBOX_TOKEN,
          geometries: 'geojson',
          overview: 'full',
          language: 'pt-BR',
          steps: 'false'
        });
        const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords.map(c=>c.join(',')).join(';')}?${qs.toString()}`;
        const r=await fetch(url);
        if(!r.ok) throw new Error('Directions '+r.status);
        const j=await r.json();
        const route=j.routes[0];
        routeFull=route.geometry;

        // desenhar linha
        const fc={type:'FeatureCollection',features:[
          {type:'Feature',properties:{kind:'route'},geometry:routeFull}
        ]};
        MAP.getSource('route-source').setData(fc);

        // enquadrar na rota
        const bbox = turf.bbox(routeFull);
        MAP.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],{padding:60});

        setStatus(`Visão geral — ${(route.distance/1000).toFixed(1)} km • ${Math.round(route.duration/60)} min`);
      }catch(e){
        console.error(e);
        setStatus('Falha no Directions (confira token/URLs).');
      }
    });
  </script>
</body>
</html>

