<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares — Navegação</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Turf: cortes/snap robustos, sem sumir linha -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#f6f7fb}
    #top{position:fixed;z-index:10;left:0;right:0;top:0;background:#fff;border-bottom:1px solid #e8eef9;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #title{font-weight:800;font-size:20px;margin-right:6px}
    select,button{padding:10px 12px;border:1px solid #d6e1f4;border-radius:10px;font-size:15px;background:#fff}
    .primary{background:#0b74de;color:#fff;border:none;font-weight:700}
    .ghost{background:#fff}
    #map{position:fixed;left:0;right:0;top:72px;bottom:168px}
    #panel{position:fixed;left:0;right:0;bottom:0;height:168px;background:#fff;border-top:1px solid #e8eef9;padding:12px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    #next{display:flex;flex-direction:column}
    #next .t{font-weight:900;font-size:18px;margin-bottom:6px}
    #next .s{color:#475569;font-size:14px}
    #float{position:fixed;right:12px;bottom:188px;display:flex;flex-direction:column;gap:8px;z-index:12}
    .fab{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #e8eef9;box-shadow:0 8px 20px rgba(0,0,0,.12);font-size:22px;cursor:pointer}
    .marker-num{background:#fff;border:2px solid #0b74de;border-radius:10px;padding:6px 8px;font-weight:800;font-size:12px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #d6e1f4;background:#fff;margin-left:6px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .muted{color:#64748b}
    @media(min-width:760px){ #map{top:84px;bottom:188px} #panel{height:188px} }
  </style>
</head>
<body>
  <div id="top">
    <div id="title">Rotas Escolares — Navegação</div>

    <label for="rotaSelect" style="font-size:14px">Escolha a rota:</label>
    <select id="rotaSelect" style="min-width:220px">
      <option value="">-- selecione --</option>
    </select>

    <button id="btnAvancar" class="primary">Avançar</button>
    <button id="btnMostrar" class="ghost">Mostrar visão geral</button>
    <button id="btnIniciar" class="primary">Iniciar Navegação</button>
    <button id="btnSimular" class="ghost">Simular</button>

    <div class="row" style="margin-left:auto">
      <label class="row muted" style="font-size:13px">
        <input type="checkbox" id="vozToggle" style="transform:scale(1.2);margin-right:6px" checked> Voz
      </label>
      <div id="status" class="muted" style="font-size:13px">Status: pronto</div>
    </div>
  </div>

  <div id="map"></div>

  <div id="float">
    <div id="btnPause" class="fab" title="Pausar">⏸️</div>
    <div id="btnStop" class="fab" title="Finalizar">⏹️</div>
  </div>

  <div id="panel">
    <div id="next">
      <div class="t" id="nextTitle">Nenhuma rota selecionada</div>
      <div class="s" id="nextSub">Selecione uma rota e toque em <b>Avançar</b>.</div>
      <div class="row muted" id="miniInfo" style="margin-top:8px;gap:12px"></div>
    </div>
    <div class="row" style="align-self:end">
      <button id="btnCenter" class="ghost">Centralizar</button>
    </div>
  </div>

  <!-- Suas rotas -->
  <script src="rotas.js"></script>

<script>
/* ===== TOKEN ===== */
const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ';
mapboxgl.accessToken = MAPBOX_TOKEN;

/* ===== Cores ===== */
const COLOR_ACTIVE   = '#3b82f6';   // azul restante
const COLOR_HALO     = '#9ec5ff';
const COLOR_TRAVELED = '#94a3b8';   // cinza percorrido
const COLOR_DRIVER   = '#ff5e3a';

/* ===== Estado ===== */
let MAP=null, markers=[], driverMarker=null, wakeLock=null;

let PONTOS=[], rotaSel=null;
let routeFull=null;           // LineString da rota inteira (visão geral)
let routeRemaining=null;      // trecho restante (azul)
let routeTraveled=null;       // trecho percorrido (cinza)

let steps=[], stepIdx=0;      // instruções
let watchId=null, simInterval=null;
let lastSnapDist=0;           // distância percorrida ao longo da linha (para monotonia)
let lastFix=null;

/* ===== UI ===== */
const rotaSelect = document.getElementById('rotaSelect');
const statusEl   = document.getElementById('status');
const vozToggle  = document.getElementById('vozToggle');
function setStatus(t){ statusEl.textContent=t; }
function setNext(t,s){ document.getElementById('nextTitle').textContent=t; document.getElementById('nextSub').textContent=s; }

/* ===== Mapa ===== */
function ensureSources(){
  if (!MAP.getSource('route-source')){
    MAP.addSource('route-source',{type:'geojson',data:{type:'FeatureCollection',features:[]}});

    MAP.addLayer({ id:'route-traveled', type:'line', source:'route-source',
      filter:['==',['get','kind'],'traveled'],
      paint:{'line-color':COLOR_TRAVELED,'line-width':8,'line-opacity':0.95,'line-cap':'round','line-join':'round'}
    });
    MAP.addLayer({ id:'route-halo', type:'line', source:'route-source',
      filter:['==',['get','kind'],'active'],
      paint:{'line-color':COLOR_HALO,'line-width':14,'line-opacity':0.9,'line-cap':'round','line-join':'round'}
    });
    MAP.addLayer({ id:'route-active', type:'line', source:'route-source',
      filter:['==',['get','kind'],'active'],
      paint:{'line-color':COLOR_ACTIVE,'line-width':8,'line-opacity':0.98,'line-cap':'round','line-join':'round'}
    });
  }
}
function setLayers(){
  ensureSources();
  const fc={type:'FeatureCollection',features:[]};
  const push = (geom, kind)=>{ if(geom && geom.coordinates && geom.coordinates.length>1){ fc.features.push({type:'Feature',properties:{kind},geometry:geom}); } };
  push(routeTraveled,'traveled');
  push(routeRemaining||routeFull,'active'); // se não há “remaining”, mostra a full
  MAP.getSource('route-source').setData(fc);
}

function initMap(){
  MAP = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/navigation-day-v1',
    center:[-48.40401957175889,-22.960993547862227],
    zoom:12
  });
  MAP.addControl(new mapboxgl.NavigationControl());
  MAP.on('load', ()=>ensureSources());
  MAP.on('styledata', ()=>ensureSources());
}
initMap();

/* ===== Util ===== */
function driverIcon(){ const el=document.createElement('div'); el.innerHTML=`<svg viewBox="0 0 24 24" width="44" height="44"><path d="M12 2 L20 20 L12 16 L4 20 Z" fill="${COLOR_DRIVER}" stroke="#b03f2a" stroke-width="0.5"/></svg>`; return el; }
function speak(t){ if(!vozToggle.checked) return; try{ const u=new SpeechSynthesisUtterance(t); u.lang='pt-BR'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function meters(a,b){ return turf.distance(turf.point(a), turf.point(b), {units:'meters'}); }
function fitTo(line){ const b=turf.bbox(line); MAP.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:60}); }

/* ===== Select de rotas ===== */
ROTAS.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=`Rota ${r.id} - ${r.nome}`; rotaSelect.appendChild(o); });

/* ===== Directions ===== */
async function getDirections(coords, withSteps=true){
  const qs = new URLSearchParams({
    access_token: MAPBOX_TOKEN,
    geometries: 'geojson',
    overview: 'full',
    language: 'pt-BR',
    steps: withSteps ? 'true' : 'false'
  });
  const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords.map(c=>c.join(',')).join(';')}?${qs.toString()}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Directions '+r.status);
  const j = await r.json();
  if (!j.routes?.length) throw new Error('Sem rota');
  return j.routes[0];
}

/* ===== Avançar ===== */
document.getElementById('btnAvancar').addEventListener('click', ()=>{
  const id=parseInt(rotaSelect.value,10);
  rotaSel = ROTAS.find(r=>r.id===id) || null;
  if (!rotaSel) { alert('Selecione uma rota.'); return; }
  PONTOS = rotaSel.pontos.map(p=>({nome:p.nome,lat:+p.latitude,lon:+p.longitude}));
  setNext(`Rota ${rotaSel.id} — ${rotaSel.nome}`,'Toque em "Mostrar visão geral".');

  // marcadores
  markers.forEach(m=>m.remove()); markers=[];
  PONTOS.forEach((p,i)=>{ const el=document.createElement('div'); el.className='marker-num'; el.textContent=(i+1);
    const mk=new mapboxgl.Marker({element:el}).setLngLat([p.lon,p.lat]).addTo(MAP); markers.push(mk); });

  // limpa linhas
  routeFull = routeRemaining = routeTraveled = null; setLayers();
});

/* ===== Mostrar visão geral (volta ao comportamento estável) ===== */
document.getElementById('btnMostrar').addEventListener('click', async ()=>{
  if(!PONTOS.length){ alert('Selecione a rota e toque em Avançar.'); return; }
  try{
    const coords=PONTOS.map(p=>[p.lon,p.lat]);
    const route = await getDirections(coords,true);

    routeFull      = route.geometry;  // linha completa
    routeRemaining = null;            // na visão geral, mostramos a full
    routeTraveled  = null;
    setLayers();
    fitTo(routeFull);

    // passos (apenas para contagem/exibição)
    steps=[]; route.legs.forEach(leg=>leg.steps.forEach(s=>{
      steps.push({text:s.maneuver.instruction, loc:s.maneuver.location});
    }));
    stepIdx=0;

    const box=document.getElementById('miniInfo'); box.innerHTML='';
    const tg1=document.createElement('div'); tg1.className='tag'; tg1.textContent=`${PONTOS.length} pontos`;
    const tg2=document.createElement('div'); tg2.className='tag'; tg2.textContent=`${steps.length} instruções`;
    box.append(tg1,tg2);

    setStatus(`Visão geral ok — ${(route.distance/1000).toFixed(1)} km • ${Math.round(route.duration/60)} min`);
    setNext('Pronto para navegar','Toque em "Iniciar Navegação".');
  }catch(e){
    console.error(e);
    routeFull = {type:'LineString',coordinates:PONTOS.map(p=>[p.lon,p.lat])};
    routeRemaining = null; routeTraveled=null; setLayers(); fitTo(routeFull);
    steps=[]; stepIdx=0; setStatus('Visão geral ok (fallback)');
  }
});

/* ===== Funções de corte (GPS e Simulação) ===== */
function snapAndSlice(lon,lat){
  // se não temos a full (ex.: não apertou Mostrar), usa a full a partir dos pontos
  if (!routeFull || !routeFull.coordinates || routeFull.coordinates.length<2){
    routeFull = {type:'LineString',coordinates:PONTOS.map(p=>[p.lon,p.lat])};
  }
  const line = turf.lineString(routeFull.coordinates);
  const start= turf.point(routeFull.coordinates[0]);
  const end  = turf.point(routeFull.coordinates[routeFull.coordinates.length-1]);
  const p    = turf.point([lon,lat]);

  const snapped = turf.nearestPointOnLine(line, p, {units:'meters'});
  const distAlong = snapped.properties.location; // em fração do índice normalizado

  // monotonia: só aceita se “andou para frente”
  const totalLen = turf.length(line,{units:'meters'});
  const travelledLen = snapped.properties.dist;  // em metros desde o início
  if (travelledLen < lastSnapDist - 1) {
    // não avançou, não recorta de novo
    return;
  }
  lastSnapDist = travelledLen;

  const traveled  = turf.lineSlice(start, snapped, line);
  const remaining = turf.lineSlice(snapped, end,   line);

  // garante 2 pontos distintos (evita 0px)
  const fix = (geom)=>{
    if (!geom || !geom.geometry) return {type:'LineString',coordinates:[]};
    const c=geom.geometry.coordinates||[];
    if (c.length===1 && routeFull.coordinates.length>1){
      c.push(routeFull.coordinates[routeFull.coordinates.length-1]);
    }
    return {type:'LineString',coordinates:c};
  };

  routeTraveled  = fix(traveled);
  routeRemaining = fix(remaining);
  setLayers();
}

/* ===== Iniciar Navegação (GPS) — corrigido ===== */
async function startNav(){
  if(!PONTOS.length){ alert('Selecione a rota, Avançar e Mostrar visão geral.'); return; }

  const startWith = (lat,lon)=>{
    // marcador motorista
    if(!driverMarker) driverMarker=new mapboxgl.Marker({element:driverIcon()}).setLngLat([lon,lat]).addTo(MAP);
    else driverMarker.setLngLat([lon,lat]);

    // 1) Corta IMEDIATO (mostra azul/cinza antes do primeiro tick do watchPosition)
    lastSnapDist = 0; // zera distância acumulada
    snapAndSlice(lon,lat);
    MAP.easeTo({center:[lon,lat],zoom:16.5,pitch:65,duration:450});

    // 2) GPS contínuo
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude,longitude} = pos.coords;
      lastFix=[longitude,latitude];
      if (driverMarker) driverMarker.setLngLat([longitude,latitude]);

      snapAndSlice(longitude,latitude); // recorta azul/cinza

      // próxima instrução (distância simples ao próximo ponto de manobra)
      if (steps.length && stepIdx<steps.length){
        const s=steps[stepIdx];
        const m=Math.round(meters([longitude,latitude],[s.loc[0],s.loc[1]]));
        setNext(`${s.text}`, `${m} m até a próxima manobra`);
        if (m<=35){ stepIdx++; if(stepIdx<steps.length) speak(steps[stepIdx].text); }
      }

      MAP.easeTo({center:[longitude,latitude], zoom:16.5, pitch:65, duration:450});
    }, err=>{ setStatus('Erro GPS: '+(err.message||err.code)); }, {enableHighAccuracy:true, maximumAge:500, timeout:12000});

    // manter tela ligada
    try{ if('wakeLock' in navigator) wakeLock=await navigator.wakeLock.request('screen'); }catch(e){}
    setStatus('Navegação ativa (GPS)');
  };

  if (lastFix){ startWith(lastFix[1], lastFix[0]); }
  else{
    navigator.geolocation.getCurrentPosition(
      p=>startWith(p.coords.latitude,p.coords.longitude),
      e=>alert('GPS: não consegui obter sua posição ('+(e.message||e.code)+')'),
      {enableHighAccuracy:true, timeout:12000}
    );
  }
}

document.getElementById('btnIniciar').addEventListener('click', startNav);

/* ===== Simulação (inalterada, estava OK) ===== */
document.getElementById('btnSimular').addEventListener('click', ()=>{
  if(!routeFull){ alert('Mostre a visão geral primeiro.'); return; }
  if (simInterval) clearInterval(simInterval);

  const coords = routeFull.coordinates.slice();
  let i=0;
  if(!driverMarker) driverMarker=new mapboxgl.Marker({element:driverIcon()}).setLngLat(coords[0]).addTo(MAP);
  else driverMarker.setLngLat(coords[0]);

  // zera e mostra “cinza + azul” desde o ponto inicial
  lastSnapDist = 0;
  snapAndSlice(coords[0][0], coords[0][1]);
  setStatus('Simulando'); stepIdx=0;

  simInterval=setInterval(()=>{
    if (i>=coords.length-1){ clearInterval(simInterval); simInterval=null; setStatus('Simulação encerrada'); return; }
    const [lon,lat]=coords[i];
    driverMarker.setLngLat([lon,lat]);
    snapAndSlice(lon,lat);
    MAP.easeTo({center:[lon,lat], zoom:16.5, pitch:65, duration:450});
    i += Math.max(1, Math.round(coords.length/220));
  }, 450);
});

/* ===== Controles ===== */
document.getElementById('btnPause').addEventListener('click', ()=>{
  setStatus('Pausado'); if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if (simInterval){ clearInterval(simInterval); simInterval=null; }
});
document.getElementById('btnStop').addEventListener('click', ()=>{
  setStatus('Finalizado'); setNext('Parado','Escolha nova rota ou mostrar visão geral.');
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(simInterval){ clearInterval(simInterval); simInterval=null; }
  try{ if(wakeLock){ wakeLock.release(); wakeLock=null; } }catch(e){}
});
document.getElementById('btnCenter').addEventListener('click', ()=>{
  if (driverMarker){ MAP.flyTo({center:driverMarker.getLngLat(), zoom:16.5, pitch:65}); }
});
</script>
</body>
</html>
