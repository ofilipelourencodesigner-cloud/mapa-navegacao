<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares â€” NavegaÃ§Ã£o</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Turf p/ bbox -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;--ink:#0b1220;--muted:#64748b;--brand:#0b74de;
      --brand2:#3b82f6;--halo:#9ec5ff;--traveled:#8e9ab0;--driver:#ff5e3a;
      --card:#fff;--line:#e8eef9
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,Helvetica,sans-serif;color:var(--ink)}
    #top{position:fixed;z-index:10;left:0;right:0;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #title{font-weight:800;font-size:20px;margin-right:6px}
    input,button{padding:10px 12px;border:1px solid #d6e1f4;border-radius:10px;font-size:15px;background:#fff}
    .primary{background:var(--brand);color:#fff;border:none;font-weight:700}
    .ghost{background:#fff}
    .muted{color:var(--muted)}
    #map{position:fixed;left:0;right:0;top:72px;bottom:0}
    .marker-num{background:#fff;border:2px solid var(--brand);border-radius:10px;padding:6px 8px;font-weight:800;font-size:12px}
    #status{margin-left:auto;font-size:13px}
    .fab{position:fixed;right:12px;bottom:18px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--line);box-shadow:0 8px 20px rgba(0,0,0,.12);font-size:22px;cursor:pointer;z-index:12}
  </style>
</head>
<body>
  <div id="top">
    <div id="title">Rotas Escolares</div>

    <label for="rotaInput" class="muted" style="font-size:14px">Digite a rota:</label>
    <input id="rotaInput" inputmode="numeric" placeholder="1" style="min-width:120px" />

    <button id="btnOverview" class="ghost">Mostrar visÃ£o geral</button>
    <button id="btnStart" class="primary">Iniciar Rota</button>

    <div id="status" class="muted">Status: pronto</div>
  </div>

  <div id="map"></div>
  <div id="btnCenter" class="fab" title="Centralizar">ðŸŽ¯</div>

  <script>
    /* ====== CONFIG ====== */
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ';
    mapboxgl.accessToken = MAPBOX_TOKEN;

    /* ====== ESTADO ====== */
    let MAP=null, ROTAS=[], rotaSel=null, PONTOS=[], markers=[];
    let plannedGeo=null;                 // LineString da rota (Directions)
    let startProg=null, currentProg=null;// progressos ao longo da rota
    let driverMarker=null, wakeLock=null;
    let navSteps=[], stepIdx=0;
    let watchId=null, lastGPS=null, bearingSmoothed=null;

    const STATUS = (t)=> document.getElementById('status').textContent=t;

    /* ====== MAPA ====== */
    function initMap(){
      MAP = new mapboxgl.Map({
        container:'map',
        style:'mapbox://styles/mapbox/navigation-day-v1',
        center:[-48.4040,-22.9610],
        zoom:12
      });
      MAP.addControl(new mapboxgl.NavigationControl());

      MAP.on('load', () => {
  MAP.addSource('route-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

  MAP.addLayer({
    id: 'route-traveled', type: 'line', source: 'route-source',
    filter: ['==', ['get', 'kind'], 'traveled'],
    paint: { 'line-color': '#8e9ab0', 'line-width': 8, 'line-opacity': 0.95 }
  });
  MAP.addLayer({
    id: 'route-halo', type: 'line', source: 'route-source',
    filter: ['==', ['get', 'kind'], 'active'],
    paint: { 'line-color': '#9ec5ff', 'line-width': 14, 'line-opacity': 0.9 }
  });
  MAP.addLayer({
    id: 'route-active', type: 'line', source: 'route-source',
    filter: ['==', ['get', 'kind'], 'active'],
    layout: { 'line-join': 'round', 'line-cap': 'round' },
    paint: { 'line-color': '#3b82f6', 'line-width': 8, 'line-opacity': 0.98 }
  });

  // << ADICIONE ESTA LINHA >>
  ensureLayerOrder();
});

// reassegura a ordem caso o estilo recarregue
MAP.on('styledata', ensureLayerOrder);

    /* ====== UTIL ====== */
    const toRad=d=>d*Math.PI/180;
    function bearingDeg(aLat,aLon,bLat,bLon){
      const Ï†1=toRad(aLat), Ï†2=toRad(bLat), Î»1=toRad(aLon), Î»2=toRad(bLon);
      const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
      const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
      return (Math.atan2(y,x)*180/Math.PI+360)%360;
    }
    function smoothBearing(newB){
      if(bearingSmoothed==null){bearingSmoothed=newB; return newB;}
      let delta=((newB-bearingSmoothed+540)%360)-180;
      bearingSmoothed=(bearingSmoothed+delta*0.25+360)%360;
      return bearingSmoothed;
    }
    function llToMeters(lon,lat){
      const x=lon*20037508.34/180;
      let y=Math.log(Math.tan((90+lat)*Math.PI/360))/(Math.PI/180);
      y=y*20037508.34/180; return {x,y};
    }
    function nearestProgress(pt, coords){
      const P=llToMeters(pt[0],pt[1]);
      let best={index:0,t:0,dist:Infinity};
      for(let i=0;i<coords.length-1;i++){
        const A=llToMeters(coords[i][0],coords[i][1]);
        const B=llToMeters(coords[i+1][0],coords[i+1][1]);
        const l2=(B.x-A.x)**2+(B.y-A.y)**2;
        let t=0;
        if(l2>0){ t=((P.x-A.x)*(B.x-A.x)+(P.y-A.y)*(B.y-A.y))/l2; t=Math.max(0,Math.min(1,t)); }
        const proj={x:A.x+t*(B.x-A.x), y:A.y+t*(B.y-A.y)};
        const dx=P.x-proj.x, dy=P.y-proj.y, d=Math.sqrt(dx*dx+dy*dy);
        if(d<best.dist) best={index:i,t,dist:d};
      }
      return best;
    }
    function coordAt(coords, prog){
      const i=Math.max(0,Math.min(coords.length-2,prog.index));
      const t=Math.max(0,Math.min(1,prog.t));
      const s=coords[i], e=coords[i+1];
      return [ s[0]+(e[0]-s[0])*t,  s[1]+(e[1]-s[1])*t ];
    }
    function sliceFrom(coords, prog){
      const out=[coordAt(coords,prog)];
      for(let k=prog.index+1;k<coords.length;k++) out.push(coords[k]);
      if(out.length===1 && coords.length>1) out.push(coords[coords.length-1]);
      return out;
    }
    function sliceBetween(coords, a, b){
      const ai=a.index + a.t/1e6, bi=b.index + b.t/1e6;
      if(bi<=ai) return [];
      if(a.index===b.index){
        const p1=coordAt(coords,a), p2=coordAt(coords,b);
        return (p1[0]===p2[0]&&p1[1]===p2[1])?[]:[p1,p2];
      }
      const out=[coordAt(coords,a)];
      for(let k=a.index+1;k<=b.index;k++) out.push(coords[k]);
      out[out.length-1]=coordAt(coords,b);
      return out;
    }
    function drawLayers(traveled, active){
      const data={
        type:'FeatureCollection',
        features:[
          ...(traveled && traveled.length>1 ? [{type:'Feature',properties:{kind:'traveled'},geometry:{type:'LineString',coordinates:traveled}}] : []),
          ...(active   && active.length>1   ? [{type:'Feature',properties:{kind:'active'},  geometry:{type:'LineString',coordinates:active}}]   : [])
        ]
      };
      if(MAP.getSource('route-source')) MAP.getSource('route-source').setData(data);
      // << ADICIONE ESTA LINHA >>
    ensureLayerOrder();
    }
    function flyNav(lon,lat,heading){
      MAP.easeTo({center:[lon,lat],zoom:16.5,pitch:65,bearing:heading??MAP.getBearing(),duration:450,
                  padding:{top:80,left:40,right:40,bottom:80}});
    }

    /* ====== ROTAS ====== */
    async function loadRotas(){
      const r=await fetch('rotas.json',{cache:'no-store'});
      ROTAS=await r.json();
    }
    loadRotas();

    /* ====== UI: VISÃƒO GERAL ====== */
    document.getElementById('btnOverview').addEventListener('click', async ()=>{
      const raw=(document.getElementById('rotaInput').value||'').toLowerCase();
      const id=parseInt(raw.replace(/\D/g,''),10);
      rotaSel = ROTAS.find(r=>r.id===id) || null;
      if(!rotaSel){ alert('Digite, por exemplo: 1 (ou "Rota 1")'); return; }

      // limpa
      markers.forEach(m=>m.remove()); markers=[];
      plannedGeo=null; startProg=null; currentProg=null; navSteps=[]; stepIdx=0;
      drawLayers([],[]);

      // pontos
      PONTOS = rotaSel.pontos.map(p=>({nome:p.nome, lat:+p.latitude, lon:+p.longitude}));
      PONTOS.forEach((p,i)=>{
        const el=document.createElement('div'); el.className='marker-num'; el.textContent=(i+1);
        const mk=new mapboxgl.Marker({element:el}).setLngLat([p.lon,p.lat]).addTo(MAP);
        markers.push(mk);
      });

      try{
        const coords=PONTOS.map(p=>[p.lon,p.lat]);
        const qs=new URLSearchParams({
          access_token:MAPBOX_TOKEN, geometries:'geojson', overview:'full', steps:'true', language:'pt-BR'
        });
        const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords.map(c=>c.join(',')).join(';')}?${qs}`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('Directions '+res.status);
        const j=await res.json();
        const route=j.routes[0];

        plannedGeo=route.geometry;
        navSteps=[]; route.legs.forEach(leg=>leg.steps.forEach(s=>navSteps.push({
          text:s.maneuver.instruction||'Siga em frente',
          loc:{lon:s.maneuver.location[0],lat:s.maneuver.location[1]}
        })));

        // visÃ£o geral = linha inteira ativa
        drawLayers([], plannedGeo.coordinates);

        const bbox=turf.bbox(plannedGeo);
        MAP.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],{padding:60});
        STATUS(`VisÃ£o geral â€” ${(route.distance/1000).toFixed(1)} km â€¢ ${Math.round(route.duration/60)} min`);
      }catch(e){
        console.warn(e);
        plannedGeo={type:'LineString',coordinates:PONTOS.map(p=>[p.lon,p.lat])};
        drawLayers([], plannedGeo.coordinates);
        const bbox=turf.bbox(plannedGeo);
        MAP.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],{padding:60});
        STATUS('VisÃ£o geral (fallback).');
      }
    });

    /* ====== INICIAR ROTA (GPS) ====== */
    document.getElementById('btnStart').addEventListener('click', ()=>{
      if(!plannedGeo?.coordinates?.length){ alert('Mostre a visÃ£o geral primeiro.'); return; }

      const beginWith=(lat,lon)=>{
        // marcador do motorista
        if(!driverMarker){
          const el=document.createElement('div');
          el.innerHTML=`<svg viewBox="0 0 24 24" width="44" height="44"><path d="M12 2 L20 20 L12 16 L4 20 Z" fill="#ff5e3a" stroke="#b03f2a" stroke-width="0.5"/></svg>`;
          driverMarker=new mapboxgl.Marker({element:el}).setLngLat([lon,lat]).addTo(MAP);
        }else{
          driverMarker.setLngLat([lon,lat]);
        }

        // **CORREÃ‡ÃƒO-CHAVE**: fixa o "ponto zero" NA POLILINHA no instante de iniciar
        startProg = nearestProgress([lon,lat], plannedGeo.coordinates);
        currentProg = startProg;

        // desenha imediatamente: azul = do motorista para frente; cinza = vazio
        drawLayers([], sliceFrom(plannedGeo.coordinates, currentProg));
        flyNav(lon,lat,null);

        // --- garante ordem correta das camadas (azul por cima, cinza por baixo)
function ensureLayerOrder() {
  try {
    if (MAP.getLayer('route-active'))   MAP.moveLayer('route-active');              // topo
    if (MAP.getLayer('route-halo'))     MAP.moveLayer('route-halo', 'route-active');
    if (MAP.getLayer('route-traveled')) MAP.moveLayer('route-traveled', 'route-halo');
  } catch (e) { /* pode disparar enquanto layers ainda nÃ£o existem; ok ignorar */ }
}

        // watch GPS
        if(watchId) try{navigator.geolocation.clearWatch(watchId);}catch(e){}
        watchId = navigator.geolocation.watchPosition(onGPS, onGPSError, {enableHighAccuracy:true, maximumAge:500, timeout:10000});
        STATUS('NavegaÃ§Ã£o ativa (GPS)');
      };

      if(lastGPS){ beginWith(lastGPS.lat,lastGPS.lon); }
      else{
        navigator.geolocation.getCurrentPosition(
          p=>beginWith(p.coords.latitude,p.coords.longitude),
          onGPSError, {enableHighAccuracy:true, timeout:10000}
        );
      }
    });

    function onGPS(pos){
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      lastGPS={lat,lon};

      if(driverMarker) driverMarker.setLngLat([lon,lat]);

      // heading/cÃ¢mera
      let heading=pos.coords.heading;
      if(heading==null && driverMarker){
        const prev=driverMarker.getLngLat();
        heading=bearingDeg(prev.lat,prev.lng,lat,lon);
      }
      if(heading!=null) heading=smoothBearing(heading);

      // progresso do motorista NA rota
      const prog=nearestProgress([lon,lat], plannedGeo.coordinates);
      // garante monotonia (nÃ£o voltar)
      if(!currentProg || (prog.index + prog.t/1e6) > (currentProg.index + currentProg.t/1e6)){
        currentProg=prog;
      }

      // azul = restante a partir do motorista; cinza = do inÃ­cio atÃ© o motorista
      const active  = sliceFrom(plannedGeo.coordinates, currentProg);
      const traveled= sliceBetween(plannedGeo.coordinates, {index:0,t:0}, currentProg);
      drawLayers(traveled, active);

      flyNav(lon,lat,heading);
    }

    function onGPSError(err){
      STATUS('Erro GPS: '+(err.message||err.code));
      alert('Erro GPS: '+(err.message||err.code));
    }

    /* Centralizar */
    document.getElementById('btnCenter').addEventListener('click', ()=>{
      if(driverMarker){
        const p=driverMarker.getLngLat();
        MAP.flyTo({center:p, zoom:16.5, pitch:65});
      }
    });
  </script>
</body>
</html>

