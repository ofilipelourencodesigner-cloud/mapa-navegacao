<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares — Entrada por número + Tela Cheia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --ink:#0b1220; --muted:#64748b;
      --brand:#0b74de; --brand-2:#3b82f6; --halo:#9ec5ff; --line:#e8eef9;
      --card:#fff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    /* Barra superior */
    #top{
      position:fixed; left:0; right:0; top:0; z-index:10;
      background:var(--card); border-bottom:1px solid var(--line);
      padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      transition:transform .25s ease;
    }
    #title{font-weight:800; font-size:18px; margin-right:6px}
    input,button{
      padding:10px 12px; border:1px solid #d6e1f4; border-radius:10px;
      font-size:15px; background:#fff
    }
    .primary{background:var(--brand); color:#fff; border:none; font-weight:700}
    .ghost{background:#fff}
    .muted{color:var(--muted)}

    /* Mapa ocupa a tela inteira, exceto a barra */
    #map{position:fixed; left:0; right:0; top:68px; bottom:0}

    /* Tela cheia: oculta a barra e expande o mapa */
    body.fs #top{transform:translateY(-100%)}
    body.fs #map{top:0}

    /* Botão flutuante para sair do FS */
    #exitFs{
      position:fixed; right:12px; top:12px; z-index:12; display:none;
      width:44px; height:44px; border-radius:999px; border:1px solid var(--line);
      background:#fff; box-shadow:0 8px 20px rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      font-size:18px;
    }
    body.fs #exitFs{display:flex}

    /* Marcadores numerados (pontos da rota) */
    .marker-num{
      background:#fff; border:2px solid var(--brand); border-radius:10px;
      padding:6px 8px; font-weight:800; font-size:12px;
    }

    /* Mensagem de status (direita da barra) */
    #status{margin-left:auto; font-size:13px}
    /* Responsivo: em telas maiores dá um pouco mais de espaço no topo */
    @media(min-width:760px){
      #map{top:82px}
      body.fs #map{top:0}
    }
  </style>
</head>
<body>
  <!-- Barra superior (entrada por número) -->
  <div id="top">
    <div id="title">Rotas Escolares</div>

    <label for="rotaInput" class="muted" style="font-size:14px">Digite a rota:</label>
    <input id="rotaInput" placeholder="ex.: Rota 1 ou 1" inputmode="numeric" style="min-width:200px" />

    <button id="btnAvancar"  class="primary">Avançar</button>
    <button id="btnOverview" class="ghost">Mostrar visão geral</button>
    <button id="btnStart"    class="primary">Iniciar Rota</button>

    <div id="status" class="muted">Status: pronto</div>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Botão para sair do modo tela cheia -->
  <button id="exitFs" title="Sair da tela cheia">⤢</button>

<script>
/* =========================================================
   1) CONFIGURAÇÕES
   ========================================================= */
const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ';
mapboxgl.accessToken = MAPBOX_TOKEN;

const DIRECTIONS_BASE = 'https://api.mapbox.com/directions/v5/mapbox/driving';

/* =========================================================
   2) ESTADO GLOBAL
   ========================================================= */
let MAP = null;            // instância do Mapbox
let ROTAS = [];            // rotas do rotas.json
let rotaSel = null;        // rota selecionada (objeto)
let PONTOS = [];           // pontos da rota selecionada
let markers = [];          // marcadores dos pontos
let plannedGeo = null;     // geometry (LineString) da rota (visão geral)

/* DOM helpers */
const $ = (id)=>document.getElementById(id);
const setStatus = (txt)=> $('status').textContent = txt;

/* =========================================================
   3) INICIALIZAÇÃO DO MAPA
   ========================================================= */
function initMap(){
  MAP = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/navigation-day-v1', // estilo de navegação (dia)
    center:[-48.40401957175889, -22.960993547862227], // centro inicial genérico
    zoom:12
  });
  MAP.addControl(new mapboxgl.NavigationControl());

  MAP.on('load', ()=>{
    // Fonte GeoJSON onde desenhamos a linha (rota)
    MAP.addSource('route-source',{type:'geojson', data: emptyFC()});

    // Halo (grossinho por baixo, dá contraste)
    MAP.addLayer({
      id:'route-halo', type:'line', source:'route-source',
      filter:['==',['get','kind'],'route'],
      paint:{'line-color':'#9ec5ff','line-width':14,'line-opacity':0.9}
    });

    // Linha azul da rota
    MAP.addLayer({
      id:'route-line', type:'line', source:'route-source',
      filter:['==',['get','kind'],'route'],
      layout:{'line-join':'round','line-cap':'round'},
      paint:{'line-color':'#3b82f6','line-width':8,'line-opacity':0.98}
    });
  });
}
initMap();

/* =========================================================
   4) CARREGAR ROTAS (rotas.json)
   ========================================================= */
async function loadRotas(){
  try{
    const r = await fetch('rotas.json', {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    ROTAS = await r.json();
    setStatus(`Rotas carregadas: ${ROTAS.length}`);
  }catch(err){
    console.error('Erro ao carregar rotas.json:', err);
    setStatus('Erro ao carregar rotas.json');
  }
}
loadRotas();

/* =========================================================
   5) PARSE DO CAMPO (aceita "Rota 1", "rota 1", "1")
   ========================================================= */
function parseRotaId(texto){
  if(!texto) return NaN;
  // remove a palavra "rota" (maiúsc/minúsc), qualquer coisa não-numérica…
  const num = parseInt(String(texto).toLowerCase().replace('rota','').replace(/\D/g,''),10);
  return num;
}

/* =========================================================
   6) UI: AVANÇAR (marca pontos, enquadra)
   ========================================================= */
$('btnAvancar').addEventListener('click', ()=>{
  const id = parseRotaId($('rotaInput').value);
  rotaSel = ROTAS.find(r=>r.id===id) || null;
  if(!rotaSel){
    alert('Digite, por exemplo: "Rota 1" ou apenas "1".');
    return;
  }

  // Limpa marcadores e linha anterior
  clearMarkers();
  setRouteFC(null);

  // Monta pontos
  PONTOS = (rotaSel.pontos||[]).map(p=>({
    nome: p.nome, lat: Number(p.latitude), lon: Number(p.longitude)
  }));

  // Cria marcadores numerados
  PONTOS.forEach((p,i)=>{
    const el = document.createElement('div');
    el.className = 'marker-num';
    el.textContent = (i+1);
    const mk = new mapboxgl.Marker({element:el})
      .setLngLat([p.lon,p.lat])
      .setPopup(new mapboxgl.Popup({offset:8}).setText(`${i+1} — ${p.nome}`))
      .addTo(MAP);
    markers.push(mk);
  });

  // Enquadrar nos pontos
  if (PONTOS.length){
    const xs=PONTOS.map(p=>p.lon), ys=PONTOS.map(p=>p.lat);
    MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});
  }
  setStatus(`Rota ${rotaSel.id} — ${rotaSel.nome} pronta (${PONTOS.length} pontos).`);
});

/* =========================================================
   7) VISÃO GERAL (Directions → linha azul completa)
   ========================================================= */
$('btnOverview').addEventListener('click', async ()=>{
  if(!PONTOS.length){
    alert('Digite a rota e clique em Avançar primeiro.');
    return;
  }
  try{
    const coords = PONTOS.map(p=>[p.lon,p.lat]);
    // Monta a URL de Directions (driving)
    const qs = new URLSearchParams({
      access_token: MAPBOX_TOKEN,
      geometries: 'geojson',
      overview: 'full',
      steps: 'false',
      language: 'pt-BR'
    });
    const url = `${DIRECTIONS_BASE}/${coords.map(c=>c.join(',')).join(';')}?${qs.toString()}`;

    const res = await fetch(url);
    if(!res.ok) throw new Error('Directions '+res.status);
    const j = await res.json();
    if(!j.routes?.length) throw new Error('Sem rota');

    const route = j.routes[0];         // pega a melhor rota
    plannedGeo = route.geometry;        // GeoJSON LineString

    // Desenha a linha
    setRouteFC(plannedGeo);

    // Enquadra a linha azul
    const xs=plannedGeo.coordinates.map(c=>c[0]);
    const ys=plannedGeo.coordinates.map(c=>c[1]);
    MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});

    setStatus(`Visão geral — ${(route.distance/1000).toFixed(1)} km • ${Math.round(route.duration/60)} min`);
  }catch(err){
    console.error('Erro no Directions:', err);
    setStatus('Falha no Directions (token/URL).');
  }
});

/* =========================================================
   8) INICIAR ROTA → ENTRAR EM TELA CHEIA
   ========================================================= */
$('btnStart').addEventListener('click', async ()=>{
  try{
    const el = document.documentElement;
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    document.body.classList.add('fs');
    setStatus('Tela cheia ativada.');
  }catch(e){
    console.warn('Fullscreen não disponível:', e);
    // Mesmo sem API de FS, escondemos a barra para experiência imersiva
    document.body.classList.add('fs');
    setStatus('Tela cheia (simulada).');
  }
});

/* Botão para sair do FS */
$('exitFs').addEventListener('click', exitFullscreenIfAny);
/* Se o usuário usar o gesto/sistema para sair, limpamos a classe */
document.addEventListener('fullscreenchange', ()=>{
  if(!document.fullscreenElement) document.body.classList.remove('fs');
});
function exitFullscreenIfAny(){
  try{
    if (document.fullscreenElement) document.exitFullscreen();
    else if (document.webkitFullscreenElement) document.webkitExitFullscreen();
  }catch(e){}
  document.body.classList.remove('fs');
  setStatus('Saiu da tela cheia.');
}

/* =========================================================
   9) HELPERS DE MAPA/GEOMETRIA
   ========================================================= */
function emptyFC(){
  return {type:'FeatureCollection', features:[]};
}
/* Atualiza a fonte com a linha da rota (ou limpa, se null) */
function setRouteFC(lineString){
  const fc = emptyFC();
  if (lineString && lineString.coordinates && lineString.coordinates.length>1){
    fc.features.push({
      type:'Feature',
      properties:{kind:'route'},
      geometry: lineString
    });
  }
  if (MAP && MAP.getSource && MAP.getSource('route-source')){
    MAP.getSource('route-source').setData(fc);
  }
}
/* Remove todos os marcadores de ponto */
function clearMarkers(){
  markers.forEach(m=>m.remove());
  markers = [];
}
</script>
</body>
</html>
