<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Teste ORS + MapTiler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .marker-num {
      background:#fff; border:2px solid #1e80ff; border-radius:10px;
      padding:4px 8px; font: 700 12px/1 system-ui, sans-serif;
      box-shadow:0 1px 4px rgba(0,0,0,.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ==== 1) SUAS CHAVES (substitua) ====
    const MAPTILER_KEY = 'LPF4PdydkUaFkn9Kv7jl';
    const ORS_KEY      = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImU3NjRjMmY0NzdhZTQ5MGY5MjJiYmRhYTIzOGM0ZDBiIiwiaCI6Im11cm11cjY0In0=';

    // ==== 2) MAPA (MapTiler + Leaflet) ====
    const map = L.map('map', { zoomControl: true }).setView([-22.95, -48.40], 12);
    L.tileLayer(
      `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      {
        tileSize: 256,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> ' +
          '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
      }
    ).addTo(map);

    // ==== 3) PONTOS DE TESTE (lon, lat) — ORDEM é longitude, latitude ====
    // Ponto A (ex.: próximo ao seu "P1")
    const A = [-48.40401957175889, -22.960993547862227];
    // Ponto B (ex.: destino de teste)
    const B = [-48.449429, -22.922624];

    // Marcadores numerados
    function numberedMarker([lon, lat], i) {
      const el = document.createElement('div');
      el.className = 'marker-num';
      el.textContent = String(i);
      return L.marker([lat, lon], { icon: L.divIcon({ html: el, className: '', iconSize: [24,24] }) });
    }
    numberedMarker(A, 1).addTo(map);
    numberedMarker(B, 2).addTo(map);

    // ==== 4) BUSCAR ROTA NA ORS (driving-car) ====
    async function fetchRoute() {
      const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';
      const body = {
        // ATENÇÃO: ORDEM é [lon, lat]
        coordinates: [ A, B ],
        instructions: true,
        instructions_format: 'text',
        language: 'pt'
      };

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': ORS_KEY,
          'Content-Type': 'application/json',
          'Accept': 'application/json, application/geo+json'
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`ORS ${res.status}: ${t}`);
      }

      const data = await res.json();
      console.log('OK ORS → objeto completo:', data);

      // Linha da rota (GeoJSON)
      const geom = data.features[0].geometry; // type: LineString
      const coords = geom.coordinates.map(([lon, lat]) => [lat, lon]); // Leaflet usa [lat, lon]
      const line = L.polyline(coords, { color: '#1e80ff', weight: 6, opacity: 0.95 }).addTo(map);

      // Ajustar enquadramento
      map.fitBounds(line.getBounds(), { padding: [30,30] });

      // Passos (instruções)
      const steps = data.features[0].properties.segments[0].steps;
      console.log('Instruções (passos):', steps);
    }

    fetchRoute().catch(err => {
      console.error('Erro buscando rota ORS:', err);
      alert('Erro buscando rota na ORS. Veja o console.');
    });
  </script>
</body>
</html>
