<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares — Visão Geral</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --ink:#0b1220; --muted:#64748b;
      --brand:#0b74de; --brand2:#3b82f6; --halo:#9ec5ff;
      --card:#fff; --line:#e8eef9;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    #top{position:fixed;left:0;right:0;top:0;z-index:10;background:var(--card);
      border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #title{font-weight:800;font-size:20px;margin-right:6px}
    input,button{padding:10px 12px;border:1px solid #d6e1f4;border-radius:10px;font-size:15px;background:#fff}
    .primary{background:var(--brand);color:#fff;border:none;font-weight:700}
    .ghost{background:#fff}
    .muted{color:var(--muted)}
    #map{position:fixed;left:0;right:0;top:72px;bottom:0}

    /* marcador numerado */
    .marker-num{background:#fff;border:2px solid var(--brand2);color:#0b1220;
      border-radius:12px;padding:6px 8px;font-weight:800;font-size:12px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  </style>
</head>
<body>
  <div id="top">
    <div id="title">Rotas Escolares</div>
    <label for="rotaInput" class="muted" style="font-size:14px">Digite a rota:</label>
    <input id="rotaInput" placeholder="ex.: 1" style="min-width:160px">
    <button id="btnOverview" class="primary">Mostrar visão geral</button>
    <div id="status" class="muted" style="margin-left:auto;font-size:13px">Status: pronto</div>
  </div>

  <div id="map"></div>

  <script>
  /* ================== CONFIG ================== */
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ'; // <<< troque aqui
  mapboxgl.accessToken = MAPBOX_TOKEN;

  /* ================== ESTADO ================== */
  let MAP = null, ROTAS = [], rotaSel = null, markers = [];
  let plannedGeo = null;

  const $ = id => document.getElementById(id);
  const setStatus = t => $('status').textContent = t;

  /* ================== MAPA ================== */
  function initMap(){
    MAP = new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/navigation-day-v1',
      center:[-48.40401957175889,-22.960993547862227],
      zoom:12
    });
    MAP.addControl(new mapboxgl.NavigationControl());

    MAP.on('load', ()=>{
      // Fonte da rota
      MAP.addSource('route-source',{ type:'geojson', data:{type:'FeatureCollection',features:[]} });

      // Halo
      MAP.addLayer({
        id:'route-halo', type:'line', source:'route-source',
        filter:['==',['get','kind'],'active'],
        paint:{ 'line-color':'#9ec5ff','line-width':14,'line-opacity':0.7 }
      });
      // Azul
      MAP.addLayer({
        id:'route-active', type:'line', source:'route-source',
        filter:['==',['get','kind'],'active'],
        layout:{'line-join':'round','line-cap':'round'},
        paint:{ 'line-color':'#3b82f6','line-width':8,'line-opacity':0.98 }
      });
    });

    MAP.on('error', e=>{ console.warn('Map error', e); setStatus('Erro no mapa base'); });
  }
  initMap();

  /* ================== DADOS ================== */
  async function loadRotas(){
    try{
      const r = await fetch('rotas.json',{cache:'no-store'});
      ROTAS = await r.json();
      setStatus('Rotas carregadas');
    }catch(e){
      console.error(e);
      setStatus('Erro ao carregar rotas.json');
    }
  }
  loadRotas();

  // Aceita "1" ou "Rota 1"
  function pickRoute(){
    const txt = String($('rotaInput').value||'').trim().toLowerCase();
    const id  = parseInt(txt.replace(/\D/g,''),10);
    return ROTAS.find(r=>r.id===id)||null;
  }

  // Parser robusto (aceita vírgula decimal e nomes diferentes)
  const parseNum = v => (typeof v==='string' ? +v.replace(',','.') : +v);

  // Atualiza a fonte/layers da rota
  function drawRouteLine(coords){
    const fc = { type:'FeatureCollection', features:[
      { type:'Feature', properties:{kind:'active'}, geometry:{ type:'LineString', coordinates:coords } }
    ]};
    const src = MAP.getSource('route-source');
    if (src) src.setData(fc);
  }

  // Mostra marcadores numerados com popups
  function addMarkers(points){
    markers.forEach(m=>m.remove()); markers=[];
    points.forEach((p,i)=>{
      const el=document.createElement('div');
      el.className='marker-num'; el.textContent=(i+1);
      const mk=new mapboxgl.Marker({element:el})
        .setLngLat([p.lon,p.lat])
        .setPopup(new mapboxgl.Popup({offset:8}).setHTML(`<b>${i+1} — ${p.nome}</b>${p.obs?('<br>'+p.obs):''}`))
        .addTo(MAP);
      markers.push(mk);
    });
  }

  // Enquadra a rota
  function fitAll(coords){
    const xs=coords.map(c=>c[0]), ys=coords.map(c=>c[1]);
    MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});
  }

  /* ================== OVERVIEW ================== */
  $('btnOverview').addEventListener('click', showOverview);

  async function showOverview(){
    rotaSel = pickRoute();
    if(!rotaSel){ alert('Digite o número da rota (ex.: 1)'); return; }

    setStatus(`Carregando rota ${rotaSel.id} — ${rotaSel.nome}...`);

    // Normaliza e ordena pelos campos "ordem"
    const pontos = (rotaSel.pontos||[])
      .map(p=>{
        const lat = parseNum(p.lat ?? p.latitude);
        const lon = parseNum(p.lon ?? p.lng ?? p.longitude);
        return { ordem:+p.ordem, nome:p.nome, lat, lon, obs:p.obs||'' };
      })
      .filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon))
      .sort((a,b)=>a.ordem-b.ordem);

    if(!pontos.length){
      setStatus('Rota sem pontos válidos'); return;
    }

    addMarkers(pontos);

    // Directions (rota completa)
    try{
      const coordsStr = pontos.map(p=>`${p.lon},${p.lat}`).join(';');
      const qs = new URLSearchParams({
        access_token:MAPBOX_TOKEN,
        geometries:'geojson',
        overview:'full',
        steps:'false',
        language:'pt-BR'
      });
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}?${qs}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Directions '+res.status);
      const j = await res.json();
      plannedGeo = j.routes[0].geometry;

      drawRouteLine(plannedGeo.coordinates);
      fitAll(plannedGeo.coordinates);
      setStatus(`Visão geral pronta — ${pontos.length} pontos`);

    }catch(e){
      console.warn('Directions falhou, usando linha direta.', e);
      // fallback: liga pontos em linha reta
      const fallback = pontos.map(p=>[p.lon,p.lat]);
      drawRouteLine(fallback);
      fitAll(fallback);
      setStatus(`Visão geral (sem Directions) — ${pontos.length} pontos`);
    }
  }
  </script>
</body>
</html>
