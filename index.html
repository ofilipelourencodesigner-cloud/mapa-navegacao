<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Rotas Escolares — Navegação</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    :root { --accent:#0b74de; --driver:#ff5e3a; --bg:#f6f7fb; }
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg)}
    #top{position:fixed;z-index:10;left:0;right:0;top:0;background:#fff;border-bottom:1px solid #e8eef9;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #title{font-weight:800;font-size:20px;margin-right:6px}
    select,button{padding:10px 12px;border:1px solid #d6e1f4;border-radius:10px;font-size:15px;background:#fff}
    .primary{background:var(--accent);color:#fff;border:none;font-weight:700}
    .ghost{background:#fff}
    #map{position:fixed;left:0;right:0;top:72px;bottom:160px}
    #panel{position:fixed;left:0;right:0;bottom:0;height:160px;background:#fff;border-top:1px solid #e8eef9;padding:12px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    #next{display:flex;flex-direction:column}
    #next .t{font-weight:800;font-size:16px;margin-bottom:6px}
    #next .s{color:#475569;font-size:14px}
    #float{position:fixed;right:12px;bottom:180px;display:flex;flex-direction:column;gap:8px;z-index:12}
    .fab{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #e8eef9;box-shadow:0 8px 20px rgba(0,0,0,.12);font-size:22px;cursor:pointer}
    .marker-num{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:6px 8px;font-weight:800;font-size:12px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #d6e1f4;background:#fff;margin-left:6px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .muted{color:#64748b}
    @media(min-width:760px){ #map{top:84px;bottom:180px} #panel{height:180px} }
  </style>
</head>
<body>
  <div id="top">
    <div id="title">Rotas Escolares — Navegação</div>

    <label for="rotaSelect" style="font-size:14px">Escolha a rota:</label>
    <select id="rotaSelect" style="min-width:220px">
      <option value="">-- selecione --</option>
    </select>

    <button id="btnAvancar" class="primary">Avançar</button>
    <button id="btnMostrar" class="ghost">Mostrar visão geral</button>
    <button id="btnIniciar" class="primary">Iniciar Navegação</button>
    <button id="btnSimular" class="ghost">Simular</button>

    <div class="row" style="margin-left:auto">
      <label class="row muted" style="font-size:13px">
        <input type="checkbox" id="vozToggle" style="transform:scale(1.2);margin-right:6px"> Voz
      </label>
      <div id="status" class="muted" style="font-size:13px">Status: pronto</div>
    </div>
  </div>

  <div id="map"></div>

  <div id="float">
    <div id="btnPause" class="fab" title="Pausar">⏸️</div>
    <div id="btnStop" class="fab" title="Finalizar">⏹️</div>
  </div>

  <div id="panel">
    <div id="next">
      <div class="t" id="nextTitle">Nenhuma rota selecionada</div>
      <div class="s" id="nextSub">Selecione uma rota e toque em <b>Avançar</b>.</div>
      <div class="row muted" id="miniInfo" style="margin-top:8px;gap:12px"></div>
    </div>
    <div class="row" style="align-self:end">
      <button id="btnCenter" class="ghost">Centralizar</button>
    </div>
  </div>

  <!-- DADOS -->
  <script src="rotas.js"></script>

  <script>
  // ======= TOKEN DO MAPBOX =======
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmlsaXBldHJhbnNwb3J0ZSIsImEiOiJjbWVtMTk1eHowZzU3Mmlva2dmejF3a3JrIn0.AqLF-HXkCaxuWL6eLBBrOQ';
  mapboxgl.accessToken = MAPBOX_TOKEN;

  // ===== Estado =====
  let MAP=null, PONTOS=[], IDX=0, baseRouteGeo=null, activeRouteGeo=null, watchId=null, simInterval=null, markers=[], driverMarker=null;
  let navSteps=[];    // instruções turn-by-turn
  let stepIdx=0;
  let wakeLock=null;
  let lastPos=null;
  let smoothedBearing=null;  // bearing suavizado
  const ARRIVAL_M=30;
  const rotaSelect=document.getElementById('rotaSelect');
  const statusEl=document.getElementById('status');
  const vozToggle=document.getElementById('vozToggle');

  function setStatus(txt){ statusEl.textContent = txt; }
  function setNext(t,s){ document.getElementById('nextTitle').textContent=t; document.getElementById('nextSub').textContent=s; }

  // ===== Mapa =====
  function initMap(){
    if (MAP) return;
    MAP = new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/navigation-day-v1',
      center:[-48.40401957175889,-22.960993547862227],
      zoom:12
    });
    MAP.addControl(new mapboxgl.NavigationControl());
    MAP.on('error', (e)=>{
      const msg=(e && e.error && (e.error.message || e.error.statusText)) ? e.error.message || e.error.statusText : 'erro desconhecido';
      setStatus(`Erro no mapa base (Styles/Tiles). ${msg}`);
    });
  }
  initMap();

  // Rotas do arquivo
  ROTAS.forEach(r=>{
    const opt=document.createElement('option');
    opt.value=r.id; opt.textContent=`Rota ${r.id} - ${r.nome}`;
    rotaSelect.appendChild(opt);
  });

  // Helpers
  function toRad(v){return v*Math.PI/180;}
  function distanceM(a,b,c,d){const R=6371000,φ1=toRad(a),φ2=toRad(c),dφ=toRad(c-a),dλ=toRad(d-b);const x=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}
  function bearingDeg(a,b,c,d){const φ1=toRad(a),φ2=toRad(c),λ1=toRad(b),λ2=toRad(d);const y=Math.sin(λ2-λ1)*Math.cos(φ2);const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);return (Math.atan2(y,x)*180/Math.PI+360)%360;}
  function wrapDelta(a,b){ // diferença mínima entre ângulos
    let d=(b-a+540)%360-180; return d;
  }
  function smoothBearing(newB){
    if (smoothedBearing==null){ smoothedBearing=newB; return smoothedBearing; }
    const delta = wrapDelta(smoothedBearing, newB);
    smoothedBearing = (smoothedBearing + delta*0.25 + 360) % 360; // suaviza 25%
    return smoothedBearing;
  }
  function limparDesenho(){
    try{ if (MAP.getLayer('route')) MAP.removeLayer('route'); }catch(e){}
    try{ if (MAP.getSource('route')) MAP.removeSource('route'); }catch(e){}
    markers.forEach(m=>m.remove()); markers=[];
    if (driverMarker){ driverMarker.remove(); driverMarker=null; }
    PONTOS=[]; baseRouteGeo=null; activeRouteGeo=null; navSteps=[]; stepIdx=0; IDX=0;
  }
  async function solicitarWakeLock(){ try{ if ('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
  function liberarWakeLock(){ try{ if (wakeLock){ wakeLock.release(); wakeLock=null; } }catch(e){} }

  // Banner info
  function atualizarMiniInfo(){
    const box=document.getElementById('miniInfo');
    box.innerHTML='';
    const tag1=document.createElement('div'); tag1.className='tag'; tag1.textContent = PONTOS.length ? `${PONTOS.length} pontos` : '—';
    const tag2=document.createElement('div'); tag2.className='tag'; tag2.textContent = navSteps.length ? `${navSteps.length} instruções` : 'sem instruções';
    box.appendChild(tag1); box.appendChild(tag2);
  }

  // Avançar
  document.getElementById('btnAvancar').addEventListener('click', ()=>{
    const id=parseInt(rotaSelect.value,10);
    const rota=ROTAS.find(r=>r.id===id);
    if (!rota){ alert('Selecione uma rota.'); return; }
    PONTOS=rota.pontos.map(p=>({nome:p.nome,lat:+p.latitude,lon:+p.longitude}));
    setNext(`Rota ${rota.id} — ${rota.nome}`, 'Toque em "Mostrar visão geral".');
    setStatus(`Rota carregada (${PONTOS.length} pontos)`);
  });

  // Mostrar visão geral (prévia a partir dos pontos)
  document.getElementById('btnMostrar').addEventListener('click', async()=>{
    if (!PONTOS.length){ alert('Selecione a rota e toque em Avançar.'); return; }
    limparDesenho();
    const id=parseInt(rotaSelect.value,10);
    const rota=ROTAS.find(r=>r.id===id);
    PONTOS=rota.pontos.map(p=>({nome:p.nome,lat:+p.latitude,lon:+p.longitude}));

    PONTOS.forEach((p,i)=>{
      const el=document.createElement('div'); el.className='marker-num'; el.textContent=(i+1);
      const mk=new mapboxgl.Marker({element:el}).setLngLat([p.lon,p.lat]).setPopup(new mapboxgl.Popup({offset:10}).setText(`${i+1} — ${p.nome}`)).addTo(MAP);
      markers.push(mk);
    });

    try{
      const coords=PONTOS.map(p=>`${p.lon},${p.lat}`).join(';');
      const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&steps=true&language=pt-BR&access_token=${MAPBOX_TOKEN}`;
      const res=await fetch(url);
      if (!res.ok){ setStatus(`Directions falhou (HTTP ${res.status}).`); throw new Error('HTTP '+res.status); }
      const j=await res.json();
      const route=j.routes[0];
      baseRouteGeo=route.geometry;
      navSteps=[]; route.legs.forEach((leg)=>leg.steps.forEach(s=>navSteps.push({text:s.maneuver.instruction,loc:{lon:s.maneuver.location[0],lat:s.maneuver.location[1]}})));
      stepIdx=0;

      if (MAP.getSource('route')){ MAP.getSource('route').setData(baseRouteGeo); }
      else{
        MAP.addSource('route',{type:'geojson',data:baseRouteGeo});
        MAP.addLayer({id:'route',type:'line',source:'route',layout:{'line-join':'round','line-cap':'round'},paint:{'line-color':'#0b74de','line-width':6,'line-opacity':0.95}});
      }
      const xs=baseRouteGeo.coordinates.map(c=>c[0]), ys=baseRouteGeo.coordinates.map(c=>c[1]);
      MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});

      setStatus(`Visão geral ok — ${(route.distance/1000).toFixed(1)} km • ${Math.round(route.duration/60)} min`);
      setNext('Pronto para navegar','Toque em "Iniciar Navegação".');
      atualizarMiniInfo();
    }catch(e){
      console.warn(e);
      const fallback={type:'Feature',geometry:{type:'LineString',coordinates:PONTOS.map(p=>[p.lon,p.lat])}};
      if (MAP.getSource('route')) MAP.getSource('route').setData(fallback);
      else{
        MAP.addSource('route',{type:'geojson',data:fallback});
        MAP.addLayer({id:'route',type:'line',source:'route',paint:{'line-color':'#888','line-width':4,'line-dasharray':[4,4]}});
      }
      const xs=PONTOS.map(p=>p.lon), ys=PONTOS.map(p=>p.lat);
      MAP.fitBounds([[Math.min(...xs),Math.min(...ys)],[Math.max(...xs),Math.max(...ys)]],{padding:60});
      setStatus('Visão geral ok (fallback).');
      setNext('Pronto para navegar','Toque em "Iniciar Navegação".');
      navSteps=[]; stepIdx=0; atualizarMiniInfo();
    }
  });

  // Falar instrução
  function falar(txt){
    if (!vozToggle.checked) return;
    try{
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'pt-BR'; u.rate = 1; u.pitch = 1;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }

  // ====== NAV REAL: re-rotear do ponto atual para os pontos restantes ======
  async function buildRouteFrom(lon,lat){
    // monta coords: driver + todos os pontos
    const coords = [[lon,lat], ...PONTOS.map(p=>[p.lon,p.lat])].map(c=>c.join(',')).join(';');
    const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&steps=true&language=pt-BR&access_token=${MAPBOX_TOKEN}`;
    const res=await fetch(url);
    if (!res.ok) throw new Error('Directions HTTP '+res.status);
    const j=await res.json();
    const route=j.routes[0];
    activeRouteGeo=route.geometry;

    // steps: todas as legs (da posição atual até o fim)
    navSteps=[]; route.legs.forEach(leg=>leg.steps.forEach(s=>navSteps.push({
      text:s.maneuver.instruction||'Siga em frente',
      loc:{lon:s.maneuver.location[0],lat:s.maneuver.location[1]}
    })));
    stepIdx=0;

    if (MAP.getSource('route')) MAP.getSource('route').setData(activeRouteGeo);
    else{
      MAP.addSource('route',{type:'geojson',data:activeRouteGeo});
      MAP.addLayer({id:'route',type:'line',source:'route',layout:{'line-join':'round','line-cap':'round'},paint:{'line-color':'#0b74de','line-width':6,'line-opacity':0.95}});
    }
  }

  // ===== GPS follow-camera =====
  function applyNavCamera(lon,lat,heading){
    // Coloca o motorista mais embaixo da tela (como no Maps)
    MAP.easeTo({
      center:[lon,lat],
      zoom:16,
      pitch:65,
      bearing:heading,
      duration:500,
      padding:{top:80,left:50,right:50,bottom:220}
    });
  }

  // ===== Handlers =====
  let navStarted=false;

  function onGPS(pos){
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    lastPos={lat,lon};

    if (!driverMarker){
      const el=document.createElement('div');
      el.innerHTML=`<svg viewBox="0 0 24 24" width="44" height="44"><path d="M12 2 L20 20 L12 16 L4 20 Z" fill="${'#ff5e3a'}" stroke="#b03f2a" stroke-width="0.5"/></svg>`;
      driverMarker=new mapboxgl.Marker({element:el}).setLngLat([lon,lat]).addTo(MAP);
    } else {
      driverMarker.setLngLat([lon,lat]);
    }

    // heading suavizado
    let heading=null;
    if (pos.coords.heading!==null) heading=pos.coords.heading;
    else if (smoothedBearing!=null && lastPos) heading=bearingDeg(lastPos.lat,lastPos.lon,lat,lon);
    if (heading!==null) heading=smoothBearing(heading);

    if (navStarted){
      applyNavCamera(lon,lat, heading ?? MAP.getBearing());

      if (navSteps.length){
        const s=navSteps[stepIdx] || null;
        if (s){
          const m=Math.round(distanceM(lat,lon,s.loc.lat,s.loc.lon));
          setNext(`${s.text}`, `${m} m até a próxima manobra`);
          if (m<=ARRIVAL_M){
            stepIdx++;
            if (stepIdx<navSteps.length){ falar(navSteps[stepIdx].text); }
            else{
              setNext('ROTA FINALIZADA','Toque em Finalizar ou selecione nova rota.');
              setStatus('Rota finalizada'); try{ navigator.geolocation.clearWatch(watchId); }catch(e){}
              watchId=null; liberarWakeLock(); navStarted=false;
            }
          }
        }
      }
    }
  }

  document.getElementById('btnIniciar').addEventListener('click', async ()=>{
    if (!PONTOS.length){ alert('Mostre a rota primeiro.'); return; }
    if (!navigator.geolocation){ alert('Sem suporte a GPS.'); return; }

    // 1) Pega posição atual (uma vez) e refaz a rota: driver -> pontos
    navigator.geolocation.getCurrentPosition(async (gp)=>{
      const lat=gp.coords.latitude, lon=gp.coords.longitude;

      try{
        await buildRouteFrom(lon,lat);
        setStatus('Navegação ativa (GPS)');
        setNext(navSteps[0]?.text || 'Siga em frente','Siga as instruções');
        falar(navSteps[0]?.text || 'Siga em frente');
        atualizarMiniInfo();

        // 2) ativa follow-camera e wake lock
        navStarted=true; smoothedBearing=null;
        applyNavCamera(lon,lat, MAP.getBearing());
        solicitarWakeLock();

        // 3) começa a acompanhar em tempo real
        try{ if (watchId) navigator.geolocation.clearWatch(watchId); }catch(e){}
        watchId = navigator.geolocation.watchPosition(onGPS, err=>{
          setStatus('Erro GPS: '+(err.message||err.code));
          alert('Erro GPS: '+(err.message||err.code));
        }, { enableHighAccuracy:true, maximumAge:500, timeout:10000 });

      }catch(e){
        console.warn(e); alert('Não foi possível iniciar a navegação (Directions).');
      }
    }, (err)=>{ alert('Não foi possível obter sua localização atual.'); }, {enableHighAccuracy:true, timeout:10000});
  });

  // Simulador (usa a rota ativa, que começa no motorista)
  document.getElementById('btnSimular').addEventListener('click', ()=>{
    if (!activeRouteGeo && !baseRouteGeo){ alert('Mostre a rota primeiro.'); return; }
    const route = activeRouteGeo || baseRouteGeo;
    if (simInterval) clearInterval(simInterval);
    const coords=route.coordinates.slice(); let i=0;
    if (!driverMarker){
      const el=document.createElement('div');
      el.innerHTML=`<svg viewBox="0 0 24 24" width="44" height="44"><path d="M12 2 L20 20 L12 16 L4 20 Z" fill="${'#ff5e3a'}" stroke="#b03f2a" stroke-width="0.5"/></svg>`;
      driverMarker=new mapboxgl.Marker({element:el}).setLngLat(coords[0]).addTo(MAP);
    }
    solicitarWakeLock(); navStarted=true;

    simInterval=setInterval(()=>{
      if (i>=coords.length){ clearInterval(simInterval); simInterval=null; setNext('Simulação encerrada',''); liberarWakeLock(); navStarted=false; return; }
      const [lon,lat]=coords[i];
      driverMarker.setLngLat([lon,lat]);
      applyNavCamera(lon,lat, MAP.getBearing());

      if (navSteps.length && stepIdx < navSteps.length){
        const s=navSteps[stepIdx]; const md=Math.round(distanceM(lat,lon,s.loc.lat,s.loc.lon));
        setNext(s.text, `${md} m (simulado)`);
        if (md<=ARRIVAL_M){ stepIdx++; if (stepIdx<navSteps.length) falar(navSteps[stepIdx].text); }
      }
      i += Math.max(1, Math.round(coords.length/220));
    }, 450);
  });

  // Controles
  document.getElementById('btnPause').addEventListener('click', ()=>{
    try{ if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus('Navegação pausada'); } }catch(e){}
    if (simInterval){ clearInterval(simInterval); simInterval=null; setStatus('Simulação pausada'); }
    liberarWakeLock(); navStarted=false;
  });
  document.getElementById('btnStop').addEventListener('click', ()=>{
    try{ if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; } }catch(e){}
    if (simInterval){ clearInterval(simInterval); simInterval=null; }
    setStatus('Finalizado'); setNext('Parado','Escolha nova rota ou mostrar visão geral.');
    liberarWakeLock(); navStarted=false;
  });
  document.getElementById('btnCenter').addEventListener('click', ()=>{
    if (driverMarker){ MAP.flyTo({center:driverMarker.getLngLat(), zoom:16, pitch:65}); }
  });
  </script>
</body>
</html>
